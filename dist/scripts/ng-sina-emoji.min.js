(function(){"use strict";angular.module("ngSinaEmoji",[]).directive("ngSinaEmoji",["$document","SinaEmojiService",function(t,e){return{restrict:"A",require:"ngModel",scope:{appKey:"@",target:"@"},link:function(o,i,n,a){var r=angular.element,s={appKey:"1362404091"},c=r.extend({},s,o);r(o.target).click(function(t){t.stopPropagation(),e.show(this,c,function(t){e.insertText(i[0],t,a)})}),t.click(function(){e.hide()})}}}]).factory("SinaEmojiService",["RemoteEmoji",function(t){return{show:function(e,o,i){function n(){var t=arguments[0]?arguments[0]:0;if(!(0>t||t>=u.length/5)){c("#emotions .categorys").html(""),s=t;for(var e=5*t;5*(t+1)>e&&e<u.length;++e)c("#emotions .categorys").append(c('<a href="javascript:void(0);">'+u[e]+"</a>"));c("#emotions .categorys a").click(function(t){t.stopPropagation(),a(c(this).text())}),c("#emotions .categorys a").each(function(){c(this).text()==r&&c(this).addClass("current")})}}function a(){var t=arguments[0]?arguments[0]:"默认",e=arguments[1]?arguments[1]-1:0;c("#emotions .container").html(""),c("#emotions .page").html(""),r=t;for(var o=72*e;72*(e+1)>o&&o<l[t].length;++o)c("#emotions .container").append(c('<a href="javascript:void(0);" title="'+l[t][o].name+'"><img src="'+l[t][o].icon+'" alt="'+l[t][o].name+'" width="22" height="22" /></a>'));c("#emotions .container a").click(function(t){t.stopPropagation(),i(c(this).attr("title")),c("#emotions").hide()});for(var o=1;o<l[t].length/72+1;++o)c("#emotions .page").append(c('<a href="javascript:void(0);"'+(o==e+1?' class="current"':"")+">"+o+"</a>"));c("#emotions .page a").click(function(e){e.stopPropagation(),a(t,c(this).text())}),c("#emotions .categorys a.current").removeClass("current"),c("#emotions .categorys a").each(function(){c(this).text()==t&&c(this).addClass("current")})}var r,s,c=angular.element,l=new Array,u=new Array,p={top:c(e)[0].offsetTop+c(e).height()+8,left:c(e)[0].offsetLeft};c("#emotions").is(":hidden")?c("#emotions").css(p).show():(c("body").append('<div id="emotions">正在加载,请稍后</div>'),c("#emotions").css(p),t({appId:o.appKey}).then(function(t){c("#emotions").html('<div style="float:right"><a href="javascript:void(0);" id="prev">&laquo;</a><a href="javascript:void(0);" id="next">&raquo;</a></div><div class="categorys"></div><div class="container"></div><div class="page"></div>');var e=t.data.data;if(!angular.isArray(e))return c("#emotions .container").html(e.error),!1;for(var o in e)""==e[o].category&&(e[o].category="默认"),void 0==l[e[o].category]&&(l[e[o].category]=new Array,u.push(e[o].category)),l[e[o].category].push({name:e[o].phrase,icon:e[o].icon});c("#emotions #prev").click(function(t){t.stopPropagation(),n(s-1)}),c("#emotions #next").click(function(t){t.stopPropagation(),n(s+1)}),n(),a()}))},hide:function(){$("#emotions").hide()},insertText:function(t,e,o){if("INPUT"===t.tagName||"TEXTAREA"===t.tagName)if(document.selection){t.focus();var i=document.selection.createRange();i.text=e,i.collapse(),i.select(),o.$setViewValue(t.value)}else if(t.selectionStart||"0"==t.selectionStart){var n=t.selectionStart,a=t.selectionEnd;t.value=t.value.substring(0,n)+e+t.value.substring(a,t.value.length),o.$setViewValue(t.value),t.selectionStart=t.selectionEnd=n+e.length}else t.value+=e,o.$setViewValue(t.value)}}}]).provider("RemoteEmoji",function(){this.$get=["$http",function(t){return function(e){var o="https://api.weibo.com/2/emotions.json";return t({method:"JSONP",url:o,params:{source:e.appId,callback:"JSON_CALLBACK"}})}}]})}).call(this);