(function(){"use strict";angular.module("ngSinaEmoji",[]).directive("ngSinaEmoji",["$document","SinaEmoji","Constant",function(t,e,o){return{restrict:"A",require:"ngModel",scope:{appKey:"@",target:"@"},link:function(n,i,a,r){var s=angular.element;o.setKey(n.appKey);var c={appKey:o.getKey()};s(n.target).click(function(t){t.stopPropagation(),n.$emit("onEmojiShow"),e.show(this,c,function(t){e.insertText(i[0],t,r),n.$emit("onEmojiLoaded")})}),t.click(function(){e.hide()})}}}]).factory("SinaEmoji",["$window","RemoteEmoji","Constant",function(t,e,o){var n,i,a=angular.element,r=new Array,s=new Array;return{show:function(c,l,m){function u(e){a("#emotions").html('<div style="float:right"><a href="javascript:void(0);" id="prev">&laquo;</a><a href="javascript:void(0);" id="next">&raquo;</a></div><div class="categorys"></div><div class="emoji-container"></div><div class="page"></div>');var o=e;if(!angular.isArray(o))return a("#emotions .emoji-container").html(o.error),!1;t.localStorage.sinaEmotions=JSON.stringify(o);for(var n in o)""==o[n].category&&(o[n].category="默认"),void 0==r[o[n].category]&&(r[o[n].category]=new Array,s.push(o[n].category)),r[o[n].category].push({name:o[n].phrase,icon:o[n].icon});a("#emotions #prev").click(function(t){t.stopPropagation(),g(i-1)}),a("#emotions #next").click(function(t){t.stopPropagation(),g(i+1)}),g(),p()}function g(){var t=arguments[0]?arguments[0]:0;if(!(0>t||t>=s.length/5)){a("#emotions .categorys").html(""),i=t;for(var e=5*t;5*(t+1)>e&&e<s.length;++e)a("#emotions .categorys").append(a('<a href="javascript:void(0);">'+s[e]+"</a>"));a("#emotions .categorys a").click(function(t){t.stopPropagation(),p(a(this).text())}),a("#emotions .categorys a").each(function(){a(this).text()==n&&a(this).addClass("current")})}}function p(){var t=arguments[0]?arguments[0]:"默认",e=arguments[1]?arguments[1]-1:0;a("#emotions .emoji-container").html(""),a("#emotions .page").html(""),n=t;for(var o=72*e;72*(e+1)>o&&o<r[t].length;++o)a("#emotions .emoji-container").append(a('<a href="javascript:void(0);" title="'+r[t][o].name+'"><img src="'+r[t][o].icon+'" alt="'+r[t][o].name+'" width="22" height="22" /></a>'));a("#emotions .emoji-container a").click(function(t){t.stopPropagation(),m(a(this).attr("title")),a("#emotions").hide()});for(var o=1;o<r[t].length/72+1;++o)a("#emotions .page").append(a('<a href="javascript:void(0);"'+(o==e+1?' class="current"':"")+">"+o+"</a>"));a("#emotions .page a").click(function(e){e.stopPropagation(),p(t,a(this).text())}),a("#emotions .categorys a.current").removeClass("current"),a("#emotions .categorys a").each(function(){a(this).text()==t&&a(this).addClass("current")})}var f={top:a(c).offset().top+a(c).height()+8,left:a(c).offset().left};if(a("#emotions").is(":hidden"))a("#emotions").css(f).show();else if(a("body").append('<div id="emotions">正在加载,请稍后</div>'),a("#emotions").css(f),t.localStorage.sinaEmotions){var d=JSON.parse(t.localStorage.sinaEmotions);u(d)}else e._getRemoteEmotions({appId:o.getKey()}).then(function(t){u(t.data.data)})},hide:function(){a("#emotions").hide()},destroy:function(){a("body").has("#emotions")&&a("#emotions").remove()},parseEmotions:function(n){function i(t){for(var e=0;e<t.length;e++){var o=t[e];a[o.phrase]=o.icon}}var a={};if(t.localStorage.sinaEmotions){var r=JSON.parse(t.localStorage.sinaEmotions);i(r)}else e._getRemoteEmotions({appId:o.getKey()}).then(function(e){t.localStorage.sinaEmotions=JSON.stringify(e.data.data),i(t.localStorage.sinaEmotions)});return e._parseEmotions(n,a)},insertText:function(t,e,o){if("INPUT"===t.tagName||"TEXTAREA"===t.tagName)if(document.selection){t.focus();var n=document.selection.createRange();n.text=e,n.collapse(),n.select(),o.$setViewValue(t.value)}else if(t.selectionStart||"0"==t.selectionStart){var i=t.selectionStart,a=t.selectionEnd;t.value=t.value.substring(0,i)+e+t.value.substring(a,t.value.length),o.$setViewValue(t.value),t.selectionStart=t.selectionEnd=i+e.length}else t.value+=e,o.$setViewValue(t.value)}}}]).factory("Constant",function(){var t="1362404091";return{setKey:function(e){e&&(t=e)},getKey:function(){return t}}}).provider("RemoteEmoji",function(){this.$get=["$http",function(t){return{_getRemoteEmotions:function(e){var o="https://api.weibo.com/2/emotions.json";return t({method:"JSONP",url:o,params:{source:e.appId,callback:"JSON_CALLBACK"}})},_parseEmotions:function(t,e){var o=t;return o=o.replace(/<.*?>/g,function(t){return t=t.replace("[","["),t=t.replace("]","]")}).replace(/\[[^\[\]]*?\]/g,function(t){var o=e[t];return o?'<img class="sina-emotion" src="'+o+'" alt="'+t+'" />':t})}}}]})}).call(this);