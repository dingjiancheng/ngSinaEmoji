(function(){"use strict";angular.module("ngSinaEmoji",[]).directive("ngSinaEmoji",["$document","SinaEmoji","Constant",function(t,e,o){return{restrict:"A",require:"ngModel",scope:{appKey:"@",target:"@"},link:function(n,a,i,r){var s=angular.element;o.setKey(n.appKey);var c={appKey:o.getKey()};s(n.target).click(function(t){t.stopPropagation(),e.show(this,c,function(t){e.insertText(a[0],t,r)})}),t.click(function(){e.hide()})}}}]).factory("SinaEmoji",["$window","RemoteEmoji","Constant",function(t,e,o){var n,a,i=angular.element,r=new Array,s=new Array;return{show:function(c,l,u){function m(e){i("#emotions").html('<div style="float:right"><a href="javascript:void(0);" id="prev">&laquo;</a><a href="javascript:void(0);" id="next">&raquo;</a></div><div class="categorys"></div><div class="emoji-container"></div><div class="page"></div>');var o=e;if(!angular.isArray(o))return i("#emotions .emoji-container").html(o.error),!1;t.localStorage.sinaEmotions=JSON.stringify(o);for(var n in o)""==o[n].category&&(o[n].category="默认"),void 0==r[o[n].category]&&(r[o[n].category]=new Array,s.push(o[n].category)),r[o[n].category].push({name:o[n].phrase,icon:o[n].icon});i("#emotions #prev").click(function(t){t.stopPropagation(),g(a-1)}),i("#emotions #next").click(function(t){t.stopPropagation(),g(a+1)}),g(),p()}function g(){var t=arguments[0]?arguments[0]:0;if(!(0>t||t>=s.length/5)){i("#emotions .categorys").html(""),a=t;for(var e=5*t;5*(t+1)>e&&e<s.length;++e)i("#emotions .categorys").append(i('<a href="javascript:void(0);">'+s[e]+"</a>"));i("#emotions .categorys a").click(function(t){t.stopPropagation(),p(i(this).text())}),i("#emotions .categorys a").each(function(){i(this).text()==n&&i(this).addClass("current")})}}function p(){var t=arguments[0]?arguments[0]:"默认",e=arguments[1]?arguments[1]-1:0;i("#emotions .emoji-container").html(""),i("#emotions .page").html(""),n=t;for(var o=72*e;72*(e+1)>o&&o<r[t].length;++o)i("#emotions .emoji-container").append(i('<a href="javascript:void(0);" title="'+r[t][o].name+'"><img src="'+r[t][o].icon+'" alt="'+r[t][o].name+'" width="22" height="22" /></a>'));i("#emotions .emoji-container a").click(function(t){t.stopPropagation(),u(i(this).attr("title")),i("#emotions").hide()});for(var o=1;o<r[t].length/72+1;++o)i("#emotions .page").append(i('<a href="javascript:void(0);"'+(o==e+1?' class="current"':"")+">"+o+"</a>"));i("#emotions .page a").click(function(e){e.stopPropagation(),p(t,i(this).text())}),i("#emotions .categorys a.current").removeClass("current"),i("#emotions .categorys a").each(function(){i(this).text()==t&&i(this).addClass("current")})}var f={top:i(c).offset().top+i(c).height()+8,left:i(c).offset().left};if(i("#emotions").is(":hidden"))i("#emotions").css(f).show();else if(i("body").append('<div id="emotions">正在加载,请稍后</div>'),i("#emotions").css(f),t.localStorage.sinaEmotions){var v=JSON.parse(t.localStorage.sinaEmotions);m(v)}else e._getRemoteEmotions({appId:o.getKey()}).then(function(t){m(t.data.data)})},hide:function(){i("#emotions").hide()},destroy:function(){i("body").has("#emotions")&&i("#emotions").remove()},parseEmotions:function(n){function a(t){for(var e=0;e<t.length;e++){var o=t[e];i[o.phrase]=o.icon}}var i={};if(t.localStorage.sinaEmotions){var r=JSON.parse(t.localStorage.sinaEmotions);a(r)}else e._getRemoteEmotions({appId:o.getKey()}).then(function(e){t.localStorage.sinaEmotions=JSON.stringify(e.data.data),a(t.localStorage.sinaEmotions)});return e._parseEmotions(n,i)},insertText:function(t,e,o){if("INPUT"===t.tagName||"TEXTAREA"===t.tagName)if(document.selection){t.focus();var n=document.selection.createRange();n.text=e,n.collapse(),n.select(),o.$setViewValue(t.value)}else if(t.selectionStart||"0"==t.selectionStart){var a=t.selectionStart,i=t.selectionEnd;t.value=t.value.substring(0,a)+e+t.value.substring(i,t.value.length),o.$setViewValue(t.value),t.selectionStart=t.selectionEnd=a+e.length}else t.value+=e,o.$setViewValue(t.value)}}}]).factory("Constant",function(){var t="1362404091";return{setKey:function(e){e&&(t=e)},getKey:function(){return t}}}).provider("RemoteEmoji",function(){this.$get=["$http",function(t){return{_getRemoteEmotions:function(e){var o="https://api.weibo.com/2/emotions.json";return t({method:"JSONP",url:o,params:{source:e.appId,callback:"JSON_CALLBACK"}})},_parseEmotions:function(t,e){var o=t;return o=o.replace(/<.*?>/g,function(t){return t=t.replace("[","["),t=t.replace("]","]")}).replace(/\[[^\[\]]*?\]/g,function(t){var o=e[t];return o?'<img class="sina-emotion" src="'+o+'" alt="'+t+'" />':t})}}}]})}).call(this);